---
import styles from "@styles/Subscriber.module.scss";
import MainLayout from "@layouts/MainLayout.astro";
import { authenticator } from "otplib";
import { db } from "@config/apis";
import Banner from "@components/Banner.astro";

let error: string | undefined;
let success: string | undefined;

const { user, acc } = Astro.locals;
if (await acc.isBanned()) return acc.toBan();
if (!user) return acc.toLogin();
if (!user.email_verified) return acc.toVerifyEmail();
if (!acc.needsToVerifyTotp()) return acc.toDash();

if (Astro.request.method === "POST")
  try {
    const data = await Astro.request.formData();
    const type = data.get("type")?.toString();

    switch (type) {
      case "verify":
        {
          const token = data.get("code");

          if (
            typeof token !== "string" ||
            (token !== user.totp_backup_code &&
              !authenticator.verify({ token, secret: user.totp_secret! }))
          ) {
            error = "Incorrect 2FA code, please try again.";
          } else {
            await db.query(
              "UPDATE session SET totp_verified = true WHERE user_id = $1;",
              [user.id]
            );
            return acc.toDash();
          }
        }
        break;
    }
  } catch (err) {
    console.error(err);
  }

if (user.totp_secret !== null)
  console.log(
    "DEBUG 2FA CODE:",
    user.email,
    user.totp_backup_code,
    authenticator.generate(user.totp_secret)
  );
---

<MainLayout>
  <main class={styles.subscriberMain}>
    <h1 class="page-title sub">Enter your 2FA code</h1>
    <Banner success={success} error={error} />
    <div class={styles.userCard}>
      <p>Please enter the code generated by your authenticator app.</p>
      <form method="post">
        <input type="text" name="type" value="verify" hidden />
        <label class={styles.input}>
          <span>Code</span>
          <div class="change-email">
            <input
              type="text"
              class:list={[styles.prettyinput, styles.code]}
              name="code"
              required
            />
            <input
              type="submit"
              class:list={[styles.prettySubmit, styles.inline]}
              value="Verify"
              required
            />
          </div>
        </label>
      </form>
    </div>
  </main>
</MainLayout>
